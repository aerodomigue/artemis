<?define ShortName = "Artemis" ?>
<?define FullName = "Artemis Desktop Game Streaming Client" ?>

<?define ShortcutName = "$(var.ShortName)" ?>
<?define ShortcutDesc = "Stream games and other applications from another PC" ?>
<?define InstallFolder = "Artemis Desktop" ?>

<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:fire="http://wixtoolset.org/schemas/v4/wxs/firewall" xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Package Name="$(var.FullName)"
           Language="1033"
           Version="!(bind.fileVersion.ArtemisExe)"
           Manufacturer="Artemis Desktop Project"
           UpgradeCode="5c09f94e-f809-4c6a-9b7b-597c99f041fe">
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." Schedule="afterInstallInitialize" />
    <MediaTemplate CompressionLevel="high" EmbedCab="yes" />

    <Property Id="MPSSVC_START">
      <RegistrySearch Id="MpsSvcStart"
                      Root="HKLM"
                      Key="System\CurrentControlSet\Services\MpsSvc"
                      Name="Start"
                      Type="raw" />
    </Property>

    <Launch Condition="Installed OR MPSSVC_START=&quot;#2&quot;"
            Message="Setup requires Windows Firewall service (MpsSvc) to be running. Please start the service and try again." />

    <Property Id="APPDATAFOLDER" Value="%LOCALAPPDATA%\Artemis Desktop Project" />

    <!-- There's no way to delete a registry key on uninstall but not major upgrade, so
        we have to roll our own deletion via custom action -->
    <CustomAction Id="DeleteRegistryKey"
                  Directory="ProgramFiles6432Folder"
                  ExeCommand="reg.exe delete &quot;HKCU\Software\Artemis Desktop Project&quot; /f"
                  Execute="deferred"
                  Return="ignore"
                  Impersonate="yes" />
    <InstallExecuteSequence>
      <Custom Action="DeleteRegistryKey"
              Before="InstallFinalize"
              Condition="Installed AND REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE" />
    </InstallExecuteSequence>

    <Component Id="ArtemisShortcuts" Directory="INSTALLFOLDER">
      <Shortcut Id="StartMenuShortcut"
                Name="$(var.ShortcutName)"
                Description="$(var.ShortcutDesc)"
                Target="[#ArtemisExe]"
                Directory="ApplicationProgramsFolder"
                WorkingDirectory="INSTALLFOLDER" />
      <RemoveFolder Id="CleanupStartMenuShortcut"
                    Directory="ApplicationProgramsFolder"
                    On="uninstall" />
      <util:RemoveFolderEx Id="CleanupAppDataFolder"
                           On="uninstall"
                           Property="APPDATAFOLDER" />
      <RegistryValue Root="HKCU"
                     Key="Software\Artemis Desktop Project"
                     Name="Installed"
                     Type="integer"
                     Value="1"
                     KeyPath="yes" />
    </Component>


    <Component Id="ArtemisDesktopShortcut" Directory="INSTALLFOLDER" Condition="ADDDESKTOPSHORTCUT=1">
      <Shortcut Id="DesktopShortcut"
                Name="$(var.ShortcutName)"
                Description="$(var.ShortcutDesc)"
                Target="[#ArtemisExe]"
                Directory="DesktopFolder"
                WorkingDirectory="INSTALLFOLDER" />
      <RemoveFolder Id="CleanupDesktopShortcut"
                    Directory="DesktopFolder"
                    On="uninstall" />
      <RegistryValue Root="HKCU"
                     Key="Software\Artemis Desktop Project"
                     Name="DesktopShortcutInstalled"
                     Type="integer"
                     Value="1" />
      <RegistryValue Root="HKCU"
                     Key="Software\Artemis Desktop Project"
                     Name="DesktopShortcutInstallState"
                     Type="integer"
                     Value="[ADDDESKTOPSHORTCUT]"
                     KeyPath="yes" />
    </Component>

    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="Artemis">
        <File Id="ArtemisExe"
              KeyPath="yes"
              Checksum="yes"
              Source="$(var.BuildDir)\app\$(var.Configuration)\Artemis.exe">
          <fire:FirewallException Id="ArtemisFirewallException"
                                  Scope="any"
                                  IgnoreFailure="yes"
                                  Name="$(var.ShortName)" />
        </File>
      </Component>
    </DirectoryRef>

    <ComponentGroup Id="ArtemisDependencies" Directory="INSTALLFOLDER">
      <Files Include="$(var.DeployDir)\**" />
    </ComponentGroup>

    <Feature Id="ProductFeature" Title="Artemis" Level="1" ConfigurableDirectory="INSTALLFOLDER">
      <ComponentRef Id="Artemis" />
      <ComponentRef Id="ArtemisShortcuts" />
      <ComponentRef Id="ArtemisDesktopShortcutState" />
      <ComponentRef Id="ArtemisDesktopShortcut" />
      <ComponentGroupRef Id="ArtemisDependencies" />
    </Feature>

    <StandardDirectory Id="DesktopFolder" />
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="INSTALLFOLDER" Name="$(var.InstallFolder)" />
    </StandardDirectory>
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="$(var.InstallFolder)" />
    </StandardDirectory>
  </Package>
</Wix>
