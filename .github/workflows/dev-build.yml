name: Development Build

on:
  push:
    branches: 
      - develop
      - dev
      - 'feature/**'
      - 'feat/**'
  workflow_dispatch:  # Allow manual triggering

env:
  QT_VERSION: '6.8.1'

jobs:
  setup-version:
    name: Setup Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Get version info
        id: version
        run: |
          # Replace slashes in branch name to create a valid string for tags and filenames
          branch_name_sanitized=$(echo "${{ github.ref_name }}" | sed 's/\//-/g')
          commit_short="${{ github.sha }}"
          commit_short="${commit_short:0:7}"
          timestamp=$(date +"%Y%m%d-%H%M")
          version="${branch_name_sanitized}-${commit_short}-${timestamp}"
          echo "version=${version}" >> $GITHUB_OUTPUT
          echo "Generated version: ${version}"
  build-windows-dev:
    name: Windows Development Build
    needs: setup-version
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0  # Needed for version info
    
    - name: Display version info
      run: echo "Using development version ${{ needs.setup-version.outputs.version }}"
    
    - name: Setup Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2022_64'
        modules: 'qtmultimedia'
    
    - name: Install dependencies
      run: |
        # Install vcpkg dependencies for Windows
        vcpkg install sdl2:x64-windows sdl2-ttf:x64-windows opus:x64-windows ffmpeg:x64-windows openssl:x64-windows
        # Set environment variables for vcpkg
        echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
        echo "CMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake" >> $env:GITHUB_ENV
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
    
    - name: Build
      run: |
        $env:PATH += ";$env:Qt6_DIR\bin"
        $env:PATH += ";C:\vcpkg\installed\x64-windows\bin"
        # Configure with vcpkg dependencies
        qmake6 moonlight-qt.pro CONFIG+=release "INCLUDEPATH+=C:\vcpkg\installed\x64-windows\include" "LIBS+=-LC:\vcpkg\installed\x64-windows\lib"
        nmake

    - name: Build AntiHooking.dll
      run: |
        $env:PATH += ";$env:Qt6_DIR\bin"
        cd AntiHooking
        qmake6 AntiHooking.pro CONFIG+=release
        nmake
        cd ..

    - name: Package Windows Development Build
      env:
        VERSION: ${{ needs.setup-version.outputs.version }}
      run: |
        mkdir windows-dev-package
        copy app\release\moonlight.exe windows-dev-package\artemis-dev.exe

        # Use windeployqt to bundle Qt dependencies
        $env:PATH += ";$env:Qt6_DIR\bin"
        windeployqt --release --no-translations --no-system-d3d-compiler --no-opengl-sw windows-dev-package\artemis-dev.exe

        # Copy vcpkg DLLs manually
        copy "C:\vcpkg\installed\x64-windows\bin\SDL2.dll" windows-dev-package\
        copy "C:\vcpkg\installed\x64-windows\bin\SDL2_ttf.dll" windows-dev-package\
        copy "C:\vcpkg\installed\x64-windows\bin\opus.dll" windows-dev-package\
        # Copy FFmpeg DLLs if they exist
        if (Test-Path "C:\vcpkg\installed\x64-windows\bin\avcodec*.dll") {
          copy "C:\vcpkg\installed\x64-windows\bin\avcodec*.dll" windows-dev-package\
        }
        if (Test-Path "C:\vcpkg\installed\x64-windows\bin\avformat*.dll") {
          copy "C:\vcpkg\installed\x64-windows\bin\avformat*.dll" windows-dev-package\
        }
        if (Test-Path "C:\vcpkg\installed\x64-windows\bin\avutil*.dll") {
          copy "C:\vcpkg\installed\x64-windows\bin\avutil*.dll" windows-dev-package\
        }
        if (Test-Path "C:\vcpkg\installed\x64-windows\bin\swresample*.dll") {
          copy "C:\vcpkg\installed\x64-windows\bin\swresample*.dll" windows-dev-package\
        }
        if (Test-Path "C:\vcpkg\installed\x64-windows\bin\swscale*.dll") {
          copy "C:\vcpkg\installed\x64-windows\bin\swscale*.dll" windows-dev-package\
        }

        # Copy OpenSSL DLLs (libcrypto-3-x64.dll)
        if (Test-Path "C:\vcpkg\installed\x64-windows\bin\libcrypto-3-x64.dll") {
          copy "C:\vcpkg\installed\x64-windows\bin\libcrypto-3-x64.dll" windows-dev-package\
        }
        if (Test-Path "C:\vcpkg\installed\x64-windows\bin\libssl-3-x64.dll") {
          copy "C:\vcpkg\installed\x64-windows\bin\libssl-3-x64.dll" windows-dev-package\
        }

        # Copy libplacebo DLL
        if (Test-Path "C:\vcpkg\installed\x64-windows\bin\libplacebo-*.dll") {
          copy "C:\vcpkg\installed\x64-windows\bin\libplacebo-*.dll" windows-dev-package\
        }

        # Copy discord-rpc.dll from repo libs
        if (Test-Path "libs\windows\lib\x64\discord-rpc.dll") {
          copy "libs\windows\lib\x64\discord-rpc.dll" windows-dev-package\
        }

        # Copy AntiHooking.dll from build output
        if (Test-Path "AntiHooking\release\AntiHooking.dll") {
          copy "AntiHooking\release\AntiHooking.dll" windows-dev-package\
        } else {
          echo "Warning: AntiHooking.dll not found in AntiHooking/release/. Ensure it builds correctly." > windows-dev-package\ANTIHOOOKING_INFO.txt
        }

        # Create info file
        echo "Artemis Desktop Development Build" > windows-dev-package\README.txt
        echo "Version: $env:VERSION" >> windows-dev-package\README.txt
        echo "Branch: ${{ github.ref_name }}" >> windows-dev-package\README.txt
        echo "Commit: ${{ github.sha }}" >> windows-dev-package\README.txt
        echo "Built: $(Get-Date)" >> windows-dev-package\README.txt
        echo "" >> windows-dev-package\README.txt
        echo "This package includes all necessary DLLs for running Artemis Desktop." >> windows-dev-package\README.txt
        echo "Simply extract and run artemis-dev.exe" >> windows-dev-package\README.txt
        echo "" >> windows-dev-package\README.txt
        echo "Optional features:" >> windows-dev-package\README.txt
        echo "- Discord RPC: Included" >> windows-dev-package\README.txt
        echo "- AntiHooking: Included if build succeeded" >> windows-dev-package\README.txt

        Compress-Archive -Path windows-dev-package\* -DestinationPath artemis-windows-$env:VERSION.zip
    
    - name: Upload Development Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: artemis-windows-${{ needs.setup-version.outputs.version }}
        path: artemis-windows-${{ needs.setup-version.outputs.version }}.zip
        retention-days: 30

  build-macos-dev:
    name: macOS Development Build
    needs: setup-version
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0
    
    - name: Display version info
      run: echo "Using development version ${{ needs.setup-version.outputs.version }}"

    - name: Setup Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'mac'
        target: 'desktop'
        modules: 'qtmultimedia'
    
    - name: Install dependencies
      run: |
        brew install create-dmg ffmpeg opus sdl2 sdl2_ttf
    
    - name: Clean any existing build
      run: |
        rm -f .qmake.stash .qmake.cache
        find . -name "Makefile*" -delete
        rm -rf moonlight-common-c/Makefile* moonlight-common-c/.qmake.stash
        rm -rf qmdnsengine/Makefile* qmdnsengine/.qmake.stash 
        rm -rf h264bitstream/Makefile* h264bitstream/.qmake.stash
        rm -rf soundio/Makefile* soundio/.qmake.stash
        rm -rf app/Makefile* app/.qmake.stash
    
    - name: Build
      run: |
        export PATH="$Qt6_DIR/bin:$PATH"
        export QMAKE="$Qt6_DIR/bin/qmake6"
        qmake6 moonlight-qt.pro CONFIG+=release CONFIG+=sdk_no_version_check
        make -j$(sysctl -n hw.ncpu)
    
    - name: Package macOS Development Build
      env:
        VERSION: ${{ needs.setup-version.outputs.version }}
      run: |
        # Create info file
        cat > build_info.txt << EOF
        Artemis Desktop Development Build
        Version: $VERSION
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        Built: $(date)
        EOF
        
        # Package with version info
        tar -czf artemis-macos-$VERSION.tar.gz -C app Moonlight.app -C .. build_info.txt
    
    - name: Upload Development Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: artemis-macos-${{ needs.setup-version.outputs.version }}
        path: artemis-macos-${{ needs.setup-version.outputs.version }}.tar.gz
        retention-days: 30

  build-linux-dev:
    name: Linux Development Build
    needs: setup-version
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0

    - name: Display version info
      run: echo "Using development version ${{ needs.setup-version.outputs.version }}"
    
    - name: Setup Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'linux'
        target: 'desktop'
        modules: 'qtmultimedia'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libegl1-mesa-dev libgl1-mesa-dev libopus-dev libsdl2-dev \
          libsdl2-ttf-dev libssl-dev libavcodec-dev libavformat-dev \
          libswscale-dev libva-dev libvdpau-dev libxkbcommon-dev \
          wayland-protocols libdrm-dev nasm libgbm-dev \
          libfreetype6-dev libasound2-dev libdbus-1-dev \
          libgles2-mesa-dev libglu1-mesa-dev libibus-1.0-dev \
          libpulse-dev libudev-dev libx11-dev libxcursor-dev \
          libxext-dev libxi-dev libxinerama-dev libxrandr-dev \
          libxss-dev libxt-dev libxv-dev libxxf86vm-dev \
          libxcb-dri3-dev libx11-xcb-dev
    
    - name: Clean any existing build
      run: |
        rm -f .qmake.stash .qmake.cache
        find . -name "Makefile*" -delete
        rm -rf moonlight-common-c/Makefile* moonlight-common-c/.qmake.stash
        rm -rf qmdnsengine/Makefile* qmdnsengine/.qmake.stash 
        rm -rf h264bitstream/Makefile* h264bitstream/.qmake.stash
        rm -rf app/Makefile* app/.qmake.stash
    
    - name: Build
      run: |
        export PATH="$Qt6_DIR/bin:$PATH"
        export QMAKE="$Qt6_DIR/bin/qmake6"
        qmake6 moonlight-qt.pro CONFIG+=release
        make -j$(nproc)
    
    - name: Package Linux Development Build
      env:
        VERSION: ${{ needs.setup-version.outputs.version }}
      run: |
        # Create info file
        cat > build_info.txt << EOF
        Artemis Desktop Development Build
        Version: $VERSION
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        Built: $(date)
        EOF
        
        # Package with version info
        tar -czf artemis-linux-$VERSION.tar.gz -C app moonlight -C .. build_info.txt
    - name: Upload Development Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: artemis-linux-${{ needs.setup-version.outputs.version }}
        path: artemis-linux-${{ needs.setup-version.outputs.version }}.tar.gz
        retention-days: 30

  build-appimage-dev:
    name: AppImage Development Build
    needs: setup-version
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0
    
    - name: Display version info
      run: echo "Using development version ${{ needs.setup-version.outputs.version }}"
    
    - name: Setup Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'linux'
        target: 'desktop'
        modules: 'qtmultimedia'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libegl1-mesa-dev libgl1-mesa-dev libopus-dev libsdl2-dev \
          libsdl2-ttf-dev libssl-dev libavcodec-dev libavformat-dev \
          libswscale-dev libva-dev libvdpau-dev libxkbcommon-dev \
          wayland-protocols libdrm-dev nasm libgbm-dev \
          libfreetype6-dev libasound2-dev libdbus-1-dev \
          libgles2-mesa-dev libglu1-mesa-dev libibus-1.0-dev \
          libpulse-dev libudev-dev libx11-dev libxcursor-dev \
          libxext-dev libxi-dev libxinerama-dev libxrandr-dev \
          libxss-dev libxt-dev libxv-dev libxxf86vm-dev \
          libxcb-dri3-dev libx11-xcb-dev file wget desktop-file-utils \
          libxcb-cursor-dev
    
    - name: Clean any existing build
      run: |
        rm -f .qmake.stash .qmake.cache
        find . -name "Makefile*" -delete
        rm -rf moonlight-common-c/Makefile* moonlight-common-c/.qmake.stash
        rm -rf qmdnsengine/Makefile* qmdnsengine/.qmake.stash 
        rm -rf h264bitstream/Makefile* h264bitstream/.qmake.stash
        rm -rf soundio/Makefile* soundio/.qmake.stash
        rm -rf app/Makefile* app/.qmake.stash
    
    - name: Build
      run: |
        export PATH="$Qt6_DIR/bin:$PATH"
        export QMAKE="$Qt6_DIR/bin/qmake6"
        # Clean any problematic files
        rm -rf AntiHooking/ || true
        rm -rf config.tests/SL/ || true
        rm -f app/test_*.cpp || true
        # Build with proper configuration
        qmake6 moonlight-qt.pro CONFIG+=release
        make -j$(nproc)
    
    - name: Verify build output
      run: |
        ls -la app/
        file app/moonlight || echo "moonlight binary not found"
        ldd app/moonlight || echo "ldd failed"
    
    - name: Create AppImage
      env:
          VERSION: ${{ needs.setup-version.outputs.version }}
      run: |
        # Download linuxdeploy and Qt plugin
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage
        
        # Create AppDir structure
        mkdir -p AppDir/usr/bin
        cp app/moonlight AppDir/usr/bin/artemis-dev
        
        # Create desktop file
        cat > AppDir/artemis-dev.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=Artemis Desktop (Dev)
        Comment=Artemis Desktop Development Build
        Exec=artemis-dev
        Icon=artemis-dev
        Categories=Game;Network;
        StartupNotify=true
        EOF
        
        # Create a simple icon placeholder
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        convert -size 256x256 xc:blue -fill white -gravity center -pointsize 24 -annotate +0+0 "Artemis\nDev" AppDir/usr/share/icons/hicolor/256x256/apps/artemis-dev.png 2>/dev/null || {
          echo "Creating placeholder icon"
          touch AppDir/usr/share/icons/hicolor/256x256/apps/artemis-dev.png
        }
        
        # Create build info
        cat > AppDir/build_info.txt << EOF
        Artemis Desktop Development Build (AppImage)
        Version: $VERSION
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        Built: $(date)
        EOF
        
        # Set environment variables for linuxdeploy
        export OUTPUT="artemis-${VERSION}-x86_64.AppImage"
        export QMAKE="$Qt6_DIR/bin/qmake6"
        export QML_SOURCES_PATH="$Qt6_DIR/qml"

        # Build AppImage
        ./linuxdeploy-x86_64.AppImage \
          --appdir AppDir \
          --executable AppDir/usr/bin/artemis-dev \
          --desktop-file AppDir/artemis-dev.desktop \
          --plugin qt \
          --output appimage
        
        # Verify and rename if necessary
        ls -la *.AppImage || echo "No AppImage files found"
        if [ ! -f "$OUTPUT" ]; then
          APPIMAGE_FILE=$(ls *.AppImage | head -n1)
          if [ -n "$APPIMAGE_FILE" ]; then
            mv "$APPIMAGE_FILE" "$OUTPUT"
            echo "Renamed $APPIMAGE_FILE to $OUTPUT"
          else
            echo "Error: No AppImage file was created"
            exit 1
          fi
        fi
        
        # Final verification
        chmod +x "$OUTPUT"
        ls -la "$OUTPUT"
        file "$OUTPUT"
    
    - name: Upload AppImage Development Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: artemis-appimage-${{ needs.setup-version.outputs.version }}
        path: artemis-${{ needs.setup-version.outputs.version }}-x86_64.AppImage
        retention-days: 30

  build-flatpak-dev:
    name: Flatpak Development Build
    needs: setup-version
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0
    
    - name: Display version info
      run: echo "Using development version ${{ needs.setup-version.outputs.version }}"
    
    - name: Install Flatpak and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y flatpak flatpak-builder
        sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
        sudo flatpak install -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08 org.kde.Platform//6.6 org.kde.Sdk//6.6
    
    - name: Create Flatpak manifest
      run: |
        cat > com.artemisdesktop.ArtemisDesktopDev.yml << 'EOF'
        app-id: com.artemisdesktop.ArtemisDesktopDev
        runtime: org.kde.Platform
        runtime-version: '6.6'
        sdk: org.kde.Sdk
        command: artemis-dev
        finish-args:
          - --share=ipc
          - --socket=x11
          - --socket=wayland
          - --socket=pulseaudio
          - --share=network
          - --device=all
          - --filesystem=home
        modules:
          - name: opus
            sources:
              - type: archive
                url: https://downloads.xiph.org/releases/opus/opus-1.4.tar.gz
                sha256: c9b32b4253be5ae63d1ff16eea06b94b5f0f2951b7a02aceef58e3a3ce49c51f
          
          - name: sdl2
            sources:
              - type: archive
                url: https://github.com/libsdl-org/SDL/releases/download/release-2.28.5/SDL2-2.28.5.tar.gz
                sha256: 332cb37d0be20cb9541739c61f79bae5a477427d79ae85e352089afdaf6666e4
          
          - name: sdl2-ttf
            sources:
              - type: archive
                url: https://github.com/libsdl-org/SDL_ttf/releases/download/release-2.20.2/SDL2_ttf-2.20.2.tar.gz
                sha256: 9dc71ed93487521b107a2c4a9ca6bf43fb62f6bddd5c26b055e6b91418a22053
          
          - name: artemis-desktop-dev
            buildsystem: simple
            build-commands:
              - rm -f .qmake.stash .qmake.cache
              - find . -name "Makefile*" -delete || true
              - rm -rf AntiHooking/ || true
              - rm -rf config.tests/SL/ || true
              - rm -f app/test_*.cpp || true
              - qmake6 moonlight-qt.pro CONFIG+=release
              - make -j$(nproc)
              - install -Dm755 app/moonlight /app/bin/artemis-dev
            sources:
              - type: dir
                path: .
            post-install:
              - |
                install -Dm644 /dev/stdin /app/share/applications/com.artemisdesktop.ArtemisDesktopDev.desktop << 'EOD'
                [Desktop Entry]
                Type=Application
                Name=Artemis Desktop (Dev)
                Comment=Artemis Desktop Development Build
                Exec=artemis-dev
                Icon=com.artemisdesktop.ArtemisDesktopDev
                Categories=Game;Network;
                EOD
        EOF
    
    - name: Build Flatpak
      env:
        VERSION: ${{ needs.setup-version.outputs.version }}
      run: |
        flatpak-builder --force-clean --repo=repo build-dir com.artemisdesktop.ArtemisDesktopDev.yml
        flatpak build-bundle repo artemis-desktop-$VERSION.flatpak com.artemisdesktop.ArtemisDesktopDev
    
    - name: Upload Flatpak Development Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: artemis-flatpak-${{ needs.setup-version.outputs.version }}
        path: artemis-desktop-${{ needs.setup-version.outputs.version }}.flatpak
        retention-days: 30

  build-steamdeck-dev:
    name: Steam Deck Development Build
    needs: setup-version
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0
    
    - name: Display version info
      run: echo "Using development version ${{ needs.setup-version.outputs.version }}"
    
    - name: Setup Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'linux'
        target: 'desktop'
        modules: 'qtmultimedia'
    
    - name: Install Steam Deck specific dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libegl1-mesa-dev libgl1-mesa-dev libopus-dev libsdl2-dev \
          libsdl2-ttf-dev libssl-dev libavcodec-dev libavformat-dev \
          libswscale-dev libva-dev libvdpau-dev libxkbcommon-dev \
          wayland-protocols libdrm-dev nasm libgbm-dev \
          libfreetype6-dev libasound2-dev libdbus-1-dev \
          libgles2-mesa-dev libglu1-mesa-dev libibus-1.0-dev \
          libpulse-dev libudev-dev libx11-dev libxcursor-dev \
          libxext-dev libxi-dev libxinerama-dev libxrandr-dev \
          libxss-dev libxt-dev libxv-dev libxxf86vm-dev \
          libxcb-dri3-dev libx11-xcb-dev
    
    - name: Build for Steam Deck
      run: |
        export PATH="$Qt6_DIR/bin:$PATH"
        export QMAKE="$Qt6_DIR/bin/qmake6"
        # Build with Steam Deck optimizations
        qmake6 moonlight-qt.pro CONFIG+=release CONFIG+=steamdeck
        make -j$(nproc)
    
    - name: Package Steam Deck Development Build
      env:
        VERSION: ${{ needs.setup-version.outputs.version }}
      run: |
        mkdir -p steamdeck-package
        cp app/moonlight steamdeck-package/artemis-dev
        
        # Create Steam Deck specific files
        cat > steamdeck-package/artemis-dev.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=Artemis Desktop (Dev)
        Comment=Artemis Desktop Development Build - Optimized for Steam Deck
        Exec=artemis-dev
        Icon=artemis-dev
        Categories=Game;Network;
        EOF
        
        # Create installation script for Steam Deck
        cat > steamdeck-package/install-steamdeck.sh << 'EOF'
        #!/bin/bash
        echo "Installing Artemis Desktop Development Build for Steam Deck..."
        
        # Create directories
        mkdir -p ~/.local/share/applications
        mkdir -p ~/.local/bin
        
        # Copy files
        cp artemis-dev ~/.local/bin/
        chmod +x ~/.local/bin/artemis-dev
        cp artemis-dev.desktop ~/.local/share/applications/
        
        echo "Installation complete!"
        echo "You can now find Artemis Desktop (Dev) in your applications menu."
        EOF
        
        chmod +x steamdeck-package/install-steamdeck.sh
        
        # Create build info
        cat > steamdeck-package/build_info.txt << EOF
        Artemis Desktop Development Build (Steam Deck)
        Version: $VERSION
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        Built: $(date)
        
        Installation:
        1. Extract this archive
        2. Run: ./install-steamdeck.sh
        3. Find Artemis Desktop (Dev) in your applications
        EOF
        
        # Create README for Steam Deck users
        cat > steamdeck-package/README-SteamDeck.md << EOF
        # Artemis Desktop for Steam Deck (Development Build)
        
        ## Installation
        1. Extract this archive to a folder
        2. Open a terminal in that folder
        3. Run: \`./install-steamdeck.sh\`
        4. The app will be available in your applications menu
        
        ## Steam Deck Specific Notes
        - This build is optimized for Steam Deck's controls and display
        - Use the touchscreen or external mouse/keyboard for initial setup
        - Game mode streaming works best with the built-in controls
        
        ## Troubleshooting
        - If you have issues, try running from terminal: \`~/.local/bin/artemis-dev\`
        - Check the build_info.txt for version details
        EOF
        
        tar -czf artemis-steamdeck-$VERSION.tar.gz -C steamdeck-package .
    
    - name: Upload Steam Deck Development Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: artemis-steamdeck-${{ needs.setup-version.outputs.version }}
        path: artemis-steamdeck-${{ needs.setup-version.outputs.version }}.tar.gz
        retention-days: 30

  create-dev-release:
    name: Create Development Release
    needs: [build-windows-dev, build-macos-dev, build-linux-dev, build-appimage-dev, build-flatpak-dev, build-steamdeck-dev]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'  # Only create releases for develop branch
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for changelog
    
    - name: Get version info
      id: version
      run: |
        branch="${{ github.ref_name }}"
        commit="${{ github.sha }}"
        commit_short="${commit:0:7}"
        timestamp=$(date +"%Y%m%d-%H%M")
        version="${branch}-${commit_short}-${timestamp}"
        echo "version=${version}" >> $GITHUB_OUTPUT
    
    - name: Generate Changelog
      id: changelog
      run: |
        # Get the last release tag (or use a fallback if none exists)
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LAST_TAG" ]; then
          # If no previous tag, get commits from last 50 commits or 7 days, whichever is less
          SINCE_DATE=$(date -d '7 days ago' '+%Y-%m-%d')
          echo "No previous release found. Getting commits since $SINCE_DATE"
          COMMITS=$(git log --since="$SINCE_DATE" --pretty=format:"%h|%s|%an|%ad" --date=short)
        else
          echo "Getting commits since last release: $LAST_TAG"
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%h|%s|%an|%ad" --date=short)
        fi
        
        # Initialize changelog sections
        FEATURES=""
        BUGFIXES=""
        IMPROVEMENTS=""
        OTHER=""
        
        # Process each commit
        while IFS='|' read -r hash subject author date; do
          if [ -z "$hash" ]; then continue; fi
          
          # Clean up the subject line
          subject=$(echo "$subject" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # Categorize commits based on keywords and patterns
          if echo "$subject" | grep -iE "^(feat|feature|add|implement|new)[:|\s]|add.*support|implement.*|new.*feature" > /dev/null; then
            FEATURES="${FEATURES}- ${subject} (${hash})\n"
          elif echo "$subject" | grep -iE "^(fix|bug|resolve|correct)[:|\s]|fix.*|bug.*fix|resolve.*|correct.*" > /dev/null; then
            BUGFIXES="${BUGFIXES}- ${subject} (${hash})\n"
          elif echo "$subject" | grep -iE "^(improve|enhance|update|optimize|refactor)[:|\s]|improve.*|enhance.*|update.*|optimize.*|refactor.*" > /dev/null; then
            IMPROVEMENTS="${IMPROVEMENTS}- ${subject} (${hash})\n"
          else
            OTHER="${OTHER}- ${subject} (${hash})\n"
          fi
        done <<< "$COMMITS"
        
        # Build the changelog
        CHANGELOG="## ğŸš§ Development Build Changelog\n\n"
        
        if [ ! -z "$FEATURES" ]; then
          CHANGELOG="${CHANGELOG}### âœ¨ New Features\n${FEATURES}\n"
        fi
        
        if [ ! -z "$BUGFIXES" ]; then
          CHANGELOG="${CHANGELOG}### ğŸ› Bug Fixes\n${BUGFIXES}\n"
        fi
        
        if [ ! -z "$IMPROVEMENTS" ]; then
          CHANGELOG="${CHANGELOG}### ğŸ”§ Improvements\n${IMPROVEMENTS}\n"
        fi
        
        if [ ! -z "$OTHER" ]; then
          CHANGELOG="${CHANGELOG}### ğŸ“ Other Changes\n${OTHER}\n"
        fi
        
        # If no categorized changes, show a simple list
        if [ -z "$FEATURES" ] && [ -z "$BUGFIXES" ] && [ -z "$IMPROVEMENTS" ] && [ -z "$OTHER" ]; then
          CHANGELOG="${CHANGELOG}### ğŸ“ Recent Changes\n"
          while IFS='|' read -r hash subject author date; do
            if [ ! -z "$hash" ]; then
              CHANGELOG="${CHANGELOG}- ${subject} (${hash})\n"
            fi
          done <<< "$COMMITS"
        fi
        
        # Save changelog to file and output
        echo -e "$CHANGELOG" > changelog.md
        echo "Generated changelog:"
        cat changelog.md
        
        # Set output for use in release
        {
          echo 'changelog<<EOF'
          cat changelog.md
          echo EOF
        } >> $GITHUB_OUTPUT
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: List downloaded files for debugging
      run: ls -R artifacts
    
    - name: Create Development Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: "ğŸš§ Development Build ${{ steps.version.outputs.version }}"
        body: |
          ğŸš§ **Development Build** ğŸš§
          
          This is an automated development build from the `${{ github.ref_name }}` branch.
          
          **âš ï¸ Warning**: Development builds are unstable and intended for testing purposes only. Use at your own risk!
          
          ---
          
          ${{ steps.changelog.outputs.changelog }}
          
          ---
          
          ## ğŸ“‹ Build Information
          - **Branch**: `${{ github.ref_name }}`
          - **Commit**: `${{ github.sha }}`
          - **Build**: #${{ github.run_number }}
          - **Built**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ## ğŸ“¥ Downloads
          Choose the appropriate build for your platform:
          
          | Platform | File | Notes |
          |----------|------|-------|
          | ğŸªŸ Windows | `artemis-windows-${{ steps.version.outputs.version }}.zip` | Standard Windows build |
          | ğŸ macOS | `artemis-macos-${{ steps.version.outputs.version }}.tar.gz` | macOS app bundle |
          | ğŸ§ Linux | `artemis-linux-${{ steps.version.outputs.version }}.tar.gz` | Generic Linux binary |
          | ğŸ“¦ AppImage | `artemis-${{ steps.version.outputs.version }}-x86_64.AppImage` | Portable Linux app |
          | ğŸ“± Flatpak | `artemis-desktop-${{ steps.version.outputs.version }}.flatpak` | Sandboxed Linux app |
          | ğŸ® Steam Deck | `artemis-steamdeck-${{ steps.version.outputs.version }}.tar.gz` | Optimized for Steam Deck |
          
          ## ğŸ”„ Installation
          1. Download the appropriate file for your platform
          2. Extract the archive
          3. Run the executable (may require additional setup on some platforms)
          
          ## ğŸ› Found a Bug?
          Please report issues on our [GitHub Issues](https://github.com/${{ github.repository }}/issues) page.
        files: |
          artifacts/*/*
        prerelease: true
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}